<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>ZDU · QMA‑C360 Campaigns</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0e1117; --panel:#151923; --panel-2:#1c1f26; --ink:#d8dee9;
      --muted:#8b93a1; --hi:#33ccff; --ok:#00ff99; --warn:#ffcc66; --fail:#ff667a;
      --card:#0f141c; --chip:#0d1117; --border:rgba(255,255,255,.08);
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,var(--panel) 0%,rgba(21,25,35,.85) 100%);
      border-bottom:2px solid var(--ok);padding:12px 18px}
    h1{margin:0;font-size:18px;color:var(--hi)}
    main{padding:20px;display:grid;gap:18px}
    section{background:var(--panel-2);border-radius:12px;padding:16px;box-shadow:0 0 0 1px rgba(255,255,255,.04) inset}
    section h2{margin:0 0 8px;color:var(--ok);font-size:16px}
    section p.lead{margin:0 0 10px;color:var(--muted)}
    .grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    .grid-2{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:2px 8px;border-radius:999px;background:var(--chip);border:1px solid var(--border);color:var(--muted);font-size:12px}
    .ok{color:var(--ok)} .warn{color:var(--warn)} .fail{color:var(--fail)}
    .small{font-size:12px;color:var(--muted)}
    table{width:100%;border-collapse:collapse;font-size:13px}
    th,td{padding:8px;border-bottom:1px solid var(--border);text-align:left;vertical-align:top}
    th{color:var(--ok);font-weight:600}
    tr:hover{background:rgba(255,255,255,.02)}
    footer{padding:14px 20px;color:var(--muted);text-align:center}
    /* NAV */
    nav{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0 0}
    nav a{color:#b9c6d6;text-decoration:none;padding:6px 10px;border:1px solid var(--border);border-radius:8px;background:var(--chip)}
    nav a:hover{border-color:#2a2f3a}
    nav a.active{background:#0b0f14;color:var(--ok);border-color:#214436}
    nav a.master{font-weight:700}
    /* skeleton */
    .skeleton{background:linear-gradient(90deg,#10151c 0%,#111822 50%,#10151c 100%);background-size:200% 100%;animation:sh 1.1s infinite;border-radius:8px;height:120px}
    @keyframes sh{0%{background-position:0 0}100%{background-position:-200% 0}}
    .controls{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
    select, input[type="search"]{background:var(--chip);border:1px solid var(--border);color:var(--ink);padding:6px 8px;border-radius:8px}
  </style>
</head>
<body>
  <header>
    <h1>ZDU · QMA‑C360 Campaigns</h1>
    <nav>
      <a class="master" href="./index.html" title="Consola Maestra (Home)">Home</a>
      <a href="./devsecops.html">DevSecOps</a>
      <a href="./content.html">Content Audit</a>
      <a href="./security.html">Security Posture</a>
      <a class="active" aria-current="page" href="./campaigns.html">QMA‑C360</a>
      <a href="./protocols.html">Protocols</a>
    </nav>
  </header>

  <main>
    <!-- KPIs clave -->
    <section>
      <h2>KPIs de Campañas</h2>
      <p class="lead">Fuente: <span class="pill">kpis_quality.json</span>. Mostramos métricas recientes (ventana: 7d).</p>
      <div id="cards" class="grid-2">
        <div class="card skeleton"></div>
        <div class="card skeleton"></div>
      </div>
      <div class="small" id="meta"></div>
    </section>

    <!-- Tabla completa -->
    <section>
      <h2>Detalle de KPIs</h2>
      <div class="controls">
        <label class="pill">Filtrar por KPI:
          <select id="kpiFilter">
            <option value="all">Todos</option>
            <option value="open_rate">open_rate</option>
            <option value="hard_bounce_rate">hard_bounce_rate</option>
          </select>
        </label>
        <label class="pill">Buscar:
          <input id="q" type="search" placeholder="Nombre / status / trend…" />
        </label>
      </div>
      <div style="overflow-x:auto">
        <table>
          <thead>
            <tr>
              <th>Nombre</th>
              <th>Valor</th>
              <th>Target</th>
              <th>Status</th>
              <th>Tendencia</th>
              <th>Ventana</th>
              <th>Fecha</th>
            </tr>
          </thead>
          <tbody id="tb">
            <tr><td colspan="7">Cargando…</td></tr>
          </tbody>
        </table>
      </div>
    </section>
  </main>

  <footer>
    ZDU QUALITY SYSTEM · QMA‑C360 · v2
  </footer>

  <script>
    const PATH = '/private/infra/scripts/logs/kpis_quality.json';
    const $ = (s)=>document.querySelector(s);
    async function j(url){ const r=await fetch(url,{cache:'no-store'}); if(!r.ok) throw new Error(`${r.status} ${url}`); return r.json(); }

    let data = [];

    function kpi(name){ return data.find(x=>x.category==='campaigns' && x.name===name); }

    function renderCards(){
      const open = kpi('open_rate') || {};
      const bounce = kpi('hard_bounce_rate') || {};
      const card = (k, label)=>`
        <div class="card">
          <div class="small">campaigns · ${label}</div>
          <div class="${k.status||'ok'}" style="font-size:28px;font-weight:700">${k.value??'–'} ${k.unit||''}</div>
          <div class="small">target: ${k.target??'–'} · trend: ${k.trend||'flat'} · win: ${k.window||'-'}</div>
          <div class="small">${k.timestamp? new Date(k.timestamp).toLocaleString() : ''}</div>
        </div>`;
      $('#cards').innerHTML = card(open, 'open_rate') + card(bounce, 'hard_bounce_rate');
      $('#meta').textContent = `Total KPIs en archivo: ${data.length}`;
    }

    function matches(row){
      const sel = $('#kpiFilter').value;
      const q = ($('#q').value||'').toLowerCase();
      const nameOk = (sel==='all' || row.name===sel);
      const txt = [row.name,row.status,row.trend,row.window].join(' ').toLowerCase();
      return row.category==='campaigns' && nameOk && (!q || txt.includes(q));
    }

    function renderTable(){
      const rows = data.filter(matches);
      const body = $('#tb');
      if(!rows.length){ body.innerHTML = '<tr><td colspan="7">Sin KPIs de campañas</td></tr>'; return; }
      body.innerHTML = rows.map(x=>`
        <tr>
          <td>${x.name}</td>
          <td class="${x.status}">${x.value} ${x.unit||''}</td>
          <td>${x.target??'-'}</td>
          <td><span class="pill ${x.status||''}">${x.status||'-'}</span></td>
          <td>${x.trend||'-'}</td>
          <td>${x.window||'-'}</td>
          <td>${x.timestamp? new Date(x.timestamp).toLocaleString() : '-'}</td>
        </tr>`).join('');
    }

    (async ()=>{
      try{
        data = await j(PATH);
        renderCards();
        renderTable();
        $('#kpiFilter').addEventListener('change', renderTable);
        $('#q').addEventListener('input', renderTable);
      }catch(e){
        $('#cards').innerHTML = `<div class="card fail small">Error al cargar KPIs: ${e.message}</div>`;
        $('#tb').innerHTML = `<tr><td colspan="7" class="fail">Error al cargar KPIs</td></tr>`;
      }
    })();
  </script>
</body>
</html>