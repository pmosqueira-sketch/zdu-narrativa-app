<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>ZDU · DevSecOps Status & Gates</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0e1117; --panel:#151923; --panel-2:#1c1f26; --ink:#d8dee9;
      --muted:#8b93a1; --hi:#33ccff; --ok:#00ff99; --warn:#ffcc66; --fail:#ff667a;
      --card:#0f141c; --chip:#0d1117; --border:rgba(255,255,255,.08);
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,var(--panel) 0%,rgba(21,25,35,.85) 100%);
      border-bottom:2px solid var(--ok);padding:12px 18px}
    h1{margin:0;font-size:18px;color:var(--hi)}
    main{padding:20px;display:grid;gap:18px;grid-template-columns:1fr}
    @media (min-width: 1100px){ main{grid-template-columns:1fr 1fr} }
    section{background:var(--panel-2);border-radius:12px;padding:16px;box-shadow:0 0 0 1px rgba(255,255,255,.04) inset}
    section h2{margin:0 0 8px;color:var(--ok);font-size:16px}
    section p.lead{margin:0 0 10px;color:var(--muted)}
    .grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:2px 8px;border-radius:999px;background:var(--chip);border:1px solid var(--border);color:var(--muted);font-size:12px}
    .ok{color:var(--ok)} .warn{color:var(--warn)} .fail{color:var(--fail)}
    .small{font-size:12px;color:var(--muted)}
    footer{padding:14px 20px;color:var(--muted);text-align:center}
    /* NAV */
    nav{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0 0}
    nav a{color:#b9c6d6;text-decoration:none;padding:6px 10px;border:1px solid var(--border);border-radius:8px;background:var(--chip)}
    nav a:hover{border-color:#2a2f3a}
    nav a.active{background:#0b0f14;color:var(--ok);border-color:#214436}
    nav a.master{font-weight:700}
    /* skeleton */
    .skeleton{background:linear-gradient(90deg,#10151c 0%,#111822 50%,#10151c 100%);background-size:200% 100%;animation:sh 1.1s infinite;border-radius:8px;height:120px}
    @keyframes sh{0%{background-position:0 0}100%{background-position:-200% 0}}
  </style>
</head>
<body>
  <header>
    <h1>ZDU · DevSecOps Status & Gates</h1>
    <!-- Menú de navegación -->
    <nav>
      <a class="master" href="./index.html" title="Consola Maestra (Home)">Home</a>
      <a class="active" aria-current="page" href="./devsecops.html">DevSecOps</a>
      <a href="./content.html">Content Audit</a>
      <a href="./security.html">Security Posture</a>
      <a href="./campaigns.html">QMA‑C360</a>
      <a href="./protocols.html">Protocols</a>
    </nav>
  </header>

  <main>
    <!-- KPIs -->
    <section style="grid-column:1/-1">
      <h2>KPIs de Pipeline</h2>
      <p class="lead">Estado actual de campañas, seguridad e infraestructura (fuente: <span class="pill">kpis_quality.json</span>).</p>
      <div id="kpi" class="grid-3">
        <div class="card skeleton"></div><div class="card skeleton"></div><div class="card skeleton"></div>
      </div>
      <div class="small" id="kpiMeta"></div>
    </section>

    <!-- Gates -->
    <section>
      <h2>Security Gate</h2>
      <p class="lead">Criterios mínimos para promover release. Edita umbrales en el código o por entorno.</p>
      <div id="gate">
        <div class="card skeleton"></div>
      </div>
    </section>

    <!-- Resumen rápido de posture -->
    <section>
      <h2>Postura de Seguridad (resumen)</h2>
      <p class="lead">Conteo de hallazgos por severidad (fuente: <span class="pill">security_posture.json</span>).</p>
      <div id="secSummary" class="card small">Cargando…</div>
    </section>
  </main>

  <footer>
    ZDU QUALITY SYSTEM · DevSecOps · v2
  </footer>

 <script>
  // Rutas
  const LOGS = '/private/infra/scripts/logs/';
  const PATH_KPIS = LOGS + 'devsecops_kpis.json';
  const PATH_GATES = LOGS + 'gates_platform.config.json';

  // Helpers
  const $ = (s)=>document.querySelector(s);
  async function j(url){ const r=await fetch(url,{cache:'no-store'}); if(!r.ok) throw new Error(`${r.status} ${url}`); return r.json(); }

  // Render KPIs (agrupados por pilar)
  function renderKPIs(kpis){
    const byPillar = kpis.reduce((a,x)=>{ (a[x.pillar]=a[x.pillar]||[]).push(x); return a; }, {});
    const order = ['delivery','quality','security','operations'];
    const head = {delivery:'Entrega',quality:'Calidad',security:'Seguridad',operations:'Operaciones'};
    const blocks = order.map(p=>`
      <div class="card">
        <div class="small" style="margin-bottom:6px"><b>${head[p]}</b></div>
        ${ (byPillar[p]||[]).map(k=>`
          <div style="display:flex;justify-content:space-between;gap:8px;margin:6px 0">
            <span class="small">${k.name}</span>
            <span class="${k.status||'ok'}" style="font-weight:700">${k.value} ${k.unit||''}</span>
          </div>
          <div class="small" style="opacity:.8">target: ${k.target??'-'} · win: ${k.window||'-'}</div>
        `).join('') || '<div class="small">—</div>'}
      </div>
    `).join('');
    $('#kpi').innerHTML = blocks;
    $('#kpiMeta').textContent = `KPIs totales: ${kpis.length}`;
  }

  // Gate platform (usa config; si falta, aplica defaults razonables)
  function evaluateGate(kpis, cfg){
    function val(name){ return Number(kpis.find(x=>x.name===name)?.value ?? NaN); }
    const defaults = {
      delivery:{deployment_frequency_min_per_7d:4, lead_time_hours_max:24, change_failure_rate_max_pct:15, mttr_hours_max:4},
      quality:{unit_test_coverage_min_pct:80, lint_errors_max:5, schema_validation_min_pct:95},
      security:{critical_vulns_open_max:0, high_vulns_open_max:3, secrets_exposed_max:0},
      operations:{staging_uptime_min_pct:99.0, error_rate_backend_max_pct:1.0}
    };
    const g = cfg || defaults;

    const checks = [
      {label:'deployment_frequency', pass: val('deployment_frequency') >= (g.delivery.deployment_frequency_min_per_7d)},
      {label:'lead_time_for_changes', pass: val('lead_time_for_changes') <= (g.delivery.lead_time_hours_max)},
      {label:'change_failure_rate', pass: val('change_failure_rate') <= (g.delivery.change_failure_rate_max_pct)},
      {label:'mttr', pass: val('mttr') <= (g.delivery.mttr_hours_max)},

      {label:'unit_test_coverage', pass: val('unit_test_coverage') >= (g.quality.unit_test_coverage_min_pct)},
      {label:'lint_errors', pass: val('lint_errors') <= (g.quality.lint_errors_max)},
      {label:'schema_validation_pass_rate', pass: val('schema_validation_pass_rate') >= (g.quality.schema_validation_min_pct)},

      {label:'critical_vulns_open', pass: val('critical_vulns_open') <= (g.security.critical_vulns_open_max)},
      {label:'high_vulns_open', pass: val('high_vulns_open') <= (g.security.high_vulns_open_max)},
      {label:'secrets_exposed', pass: val('secrets_exposed') <= (g.security.secrets_exposed_max)},

      {label:'staging_uptime', pass: val('staging_uptime') >= (g.operations.staging_uptime_min_pct)},
      {label:'error_rate_backend', pass: val('error_rate_backend') <= (g.operations.error_rate_backend_max_pct)},
    ];
    const pass = checks.every(c=>c.pass);
    const reasons = checks.map(c=>`${c.label}: ${c.pass?'OK':'FAIL'}`);
    $('#gate').innerHTML = `
      <div class="card ${pass?'ok':'fail'}">
        <b>Platform Gate</b><br>${pass?'PASS ✅':'FAIL ❌'}<br>
        <div class="small" style="margin-top:6px">${reasons.join(' · ')}</div>
      </div>`;
  }

  (async ()=>{
    try{
      const [kpis, cfg] = await Promise.allSettled([ j(PATH_KPIS), j(PATH_GATES) ]);
      if(kpis.status!=='fulfilled') throw new Error('KPIs no disponibles');
      renderKPIs(kpis.value);
      evaluateGate(kpis.value, cfg.status==='fulfilled' ? cfg.value : null);
    }catch(e){
      $('#kpi').innerHTML = '<div class="card fail small">Error al cargar KPIs de plataforma</div>';
      $('#gate').innerHTML = '<div class="card fail small">No se pudo evaluar el gate</div>';
    }
  })();
</script>
</body>
</html>