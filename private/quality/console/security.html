<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>ZDU · Security Posture</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0e1117; --panel:#151923; --panel-2:#1c1f26; --ink:#d8dee9;
      --muted:#8b93a1; --hi:#33ccff; --ok:#00ff99; --warn:#ffcc66; --fail:#ff667a;
      --card:#0f141c; --chip:#0d1117; --border:rgba(255,255,255,.08);
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,var(--panel) 0%,rgba(21,25,35,.85) 100%);
      border-bottom:2px solid var(--ok);padding:12px 18px}
    h1{margin:0;font-size:18px;color:var(--hi)}
    main{padding:20px;display:grid;gap:18px}
    section{background:var(--panel-2);border-radius:12px;padding:16px;box-shadow:0 0 0 1px rgba(255,255,255,.04) inset}
    section h2{margin:0 0 8px;color:var(--ok);font-size:16px}
    section p.lead{margin:0 0 10px;color:var(--muted)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:2px 8px;border-radius:999px;background:var(--chip);border:1px solid var(--border);color:var(--muted);font-size:12px}
    .critical{color:#ff4d6d} .high{color:#ff9966} .medium{color:#ffcc66} .low{color:#9fb3c8}
    .ok{color:var(--ok)} .warn{color:var(--warn)} .fail{color:var(--fail)}
    table{width:100%;border-collapse:collapse;font-size:13px}
    th,td{padding:8px;border-bottom:1px solid var(--border);text-align:left;vertical-align:top}
    th{color:var(--ok);font-weight:600}
    tr:hover{background:rgba(255,255,255,.02)}
    footer{padding:14px 20px;color:var(--muted);text-align:center}
    /* NAV */
    nav{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0 0}
    nav a{color:#b9c6d6;text-decoration:none;padding:6px 10px;border:1px solid var(--border);border-radius:8px;background:var(--chip)}
    nav a:hover{border-color:#2a2f3a}
    nav a.active{background:#0b0f14;color:var(--ok);border-color:#214436}
    nav a.master{font-weight:700}
    /* skeleton */
    .skeleton{background:linear-gradient(90deg,#10151c 0%,#111822 50%,#10151c 100%);background-size:200% 100%;animation:sh 1.1s infinite;border-radius:8px;height:120px}
    @keyframes sh{0%{background-position:0 0}100%{background-position:-200% 0}}
    .controls{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
    select, input[type="search"]{background:var(--chip);border:1px solid var(--border);color:var(--ink);padding:6px 8px;border-radius:8px}
    code{background:#0b0f14;padding:2px 4px;border-radius:4px}
  </style>
</head>
<body>
  <header>
    <h1>ZDU · Security Posture</h1>
    <nav>
      <a class="master" href="./index.html" title="Consola Maestra (Home)">Home</a>
      <a href="./devsecops.html">DevSecOps</a>
      <a href="./content.html">Content Audit</a>
      <a class="active" aria-current="page" href="./security.html">Security Posture</a>
      <a href="./campaigns.html">QMA‑C360</a>
      <a href="./protocols.html">Protocols</a>
    </nav>
  </header>

  <main>
    <section>
      <h2>Resumen por Severidad</h2>
      <p class="lead">Fuente: <span class="pill">security_posture.json</span>. Prioriza primero <span class="critical">critical</span> y <span class="high">high</span>.</p>
      <div id="sum" class="row">
        <div class="card skeleton" style="width:160px"></div>
        <div class="card skeleton" style="width:160px"></div>
        <div class="card skeleton" style="width:160px"></div>
      </div>
      <div class="controls">
        <label class="pill">Filtrar severidad:
          <select id="sev">
            <option value="all">Todas</option>
            <option value="critical">critical</option>
            <option value="high">high</option>
            <option value="medium">medium</option>
            <option value="low">low</option>
          </select>
        </label>
        <label class="pill">Buscar:
          <input id="q" type="search" placeholder="target / evidencia / tipo…" />
        </label>
      </div>
    </section>

    <section>
      <h2>Hallazgos</h2>
      <div style="overflow-x:auto">
        <table>
          <thead>
            <tr>
              <th>Severidad</th>
              <th>Tipo</th>
              <th>Target</th>
              <th>Evidencia</th>
              <th>Recomendación</th>
              <th>Owner</th>
              <th>Status</th>
              <th>Fecha</th>
            </tr>
          </thead>
          <tbody id="tb">
            <tr><td colspan="8">Cargando…</td></tr>
          </tbody>
        </table>
      </div>
    </section>
  </main>

  <footer>
    ZDU QUALITY SYSTEM · Security Posture · v2
  </footer>

  <script>
    const LOGS = '/private/infra/scripts/logs/';
    const PATH_SEC = LOGS + 'security_posture.json';

    const $ = (s)=>document.querySelector(s);
    async function j(url){ const r=await fetch(url,{cache:'no-store'}); if(!r.ok) throw new Error(`${r.status} ${url}`); return r.json(); }

    let data = [];
    const sevRank = {critical:3, high:2, medium:1, low:0};

    function renderSummary(rows){
      const agg = rows.reduce((a,x)=>{a[x.severity]=(a[x.severity]||0)+1; return a;},{});
      const chips = Object.entries(agg).sort((a,b)=>sevRank[b[0]]-sevRank[a[0]])
        .map(([k,v])=>`<span class="pill ${k}">${k}: <b>${v}</b></span>`).join(' ');
      $('#sum').innerHTML = chips || '<span class="pill">Sin hallazgos</span>';
    }

    function matchesFilter(row){
      const sel = $('#sev').value;
      const q = ($('#q').value||'').toLowerCase();
      const inSev = (sel==='all' || row.severity===sel);
      const txt = [row.type,row.target,row.evidence,row.recommended_fix,row.owner,row.status].join(' ').toLowerCase();
      return inSev && (!q || txt.includes(q));
    }

    function renderTable(rows){
      const body = $('#tb');
      if(!rows.length){ body.innerHTML = '<tr><td colspan="8">Sin resultados</td></tr>'; return; }
      body.innerHTML = rows
        .sort((a,b)=> (sevRank[b.severity] - sevRank[a.severity]))
        .map(x=>`
          <tr>
            <td class="${x.severity}">${x.severity}</td>
            <td>${x.type||''}</td>
            <td><code>${x.target||''}</code></td>
            <td>${x.evidence||'-'}</td>
            <td>${x.recommended_fix||'-'}</td>
            <td>${x.owner||'-'}</td>
            <td>${x.status||'-'}</td>
            <td>${x.timestamp? new Date(x.timestamp).toLocaleString() : '-'}</td>
          </tr>
        `).join('');
    }

    function refresh(){
      const filtered = data.filter(matchesFilter);
      renderSummary(filtered);
      renderTable(filtered);
    }

    (async ()=>{
      try{
        data = await j(PATH_SEC);
        // Normaliza severidad en minúsculas
        data = Array.isArray(data) ? data.map(x=>({...x, severity:String(x.severity||'').toLowerCase()})) : [];
        refresh();
        $('#sev').addEventListener('change', refresh);
        $('#q').addEventListener('input', refresh);
      }catch(e){
        $('#tb').innerHTML = `<tr><td colspan="8" class="fail">Error: ${e.message}</td></tr>`;
        $('#sum').innerHTML = `<span class="pill fail">No se pudo cargar security_posture.json</span>`;
      }
    })();
  </script>
</body>
</html>