<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>ZDU · Protocols (Fast Response · COMIX · IFRL · Cerebrum · COMCON)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0e1117; --panel:#151923; --panel-2:#1c1f26; --ink:#d8dee9;
      --muted:#8b93a1; --hi:#33ccff; --ok:#00ff99; --warn:#ffcc66; --fail:#ff667a;
      --card:#0f141c; --chip:#0d1117; --border:rgba(255,255,255,.08);
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,var(--panel) 0%,rgba(21,25,35,.85) 100%);
      border-bottom:2px solid var(--ok);padding:12px 18px}
    h1{margin:0;font-size:18px;color:var(--hi)}
    main{padding:20px;display:grid;gap:18px;grid-template-columns:1fr}
    @media (min-width:1100px){ main{grid-template-columns:1fr 1fr} }
    section{background:var(--panel-2);border-radius:12px;padding:16px;box-shadow:0 0 0 1px rgba(255,255,255,.04) inset}
    section h2{margin:0 0 8px;color:var(--ok);font-size:16px}
    section p.lead{margin:0 0 10px;color:var(--muted)}
    .grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:2px 8px;border-radius:999px;background:var(--chip);border:1px solid var(--border);color:var(--muted);font-size:12px}
    .ok{color:var(--ok)} .warn{color:var(--warn)} .fail{color:var(--fail)}
    .small{font-size:12px;color:var(--muted)}
    table{width:100%;border-collapse:collapse;font-size:13px}
    th,td{padding:8px;border-bottom:1px solid var(--border);text-align:left;vertical-align:top}
    th{color:var(--ok);font-weight:600}
    tr:hover{background:rgba(255,255,255,.02)}
    footer{padding:14px 20px;color:var(--muted);text-align:center}
    /* NAV */
    nav{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0 0}
    nav a{color:#b9c6d6;text-decoration:none;padding:6px 10px;border:1px solid var(--border);border-radius:8px;background:var(--chip)}
    nav a:hover{border-color:#2a2f3a}
    nav a.active{background:#0b0f14;color:var(--ok);border-color:#214436}
    nav a.master{font-weight:700}
    /* skeleton */
    .skeleton{background:linear-gradient(90deg,#10151c 0%,#111822 50%,#10151c 100%);background-size:200% 100%;animation:sh 1.1s infinite;border-radius:8px;height:120px}
    @keyframes sh{0%{background-position:0 0}100%{background-position:-200% 0}}
    code{background:#0b0f14;padding:2px 4px;border-radius:4px}
    /* --- Simple Markdown Styles --- */
    .md{padding:14px}
    .md h1,.md h2,.md h3,.md h4{margin:10px 0;color:var(--ok)}
    .md p{margin:8px 0}
    .md code{background:#0b0f14;border:1px solid var(--border);padding:2px 4px;border-radius:4px}
    .md pre{background:#0b0f14;border:1px solid var(--border);padding:10px;border-radius:8px;overflow:auto}
    .md blockquote{border-left:3px solid var(--hi);margin:8px 0;padding:6px 10px;background:#0f141c;color:#cbd5e1}
    .md ul{padding-left:20px;margin:6px 0}
    .md li{margin:3px 0}
    .md a{color:#9adfff;text-decoration:none;border-bottom:1px dotted #4aa3c7}
    .md hr{border:none;border-top:1px solid var(--border);margin:12px 0}
  </style>
</head>
<body>
  <header>
    <h1>ZDU · Protocols</h1>
    <nav>
      <a class="master" href="./index.html" title="Consola Maestra (Home)">Home</a>
      <a href="./devsecops.html">DevSecOps</a>
      <a href="./content.html">Content Audit</a>
      <a href="./security.html">Security Posture</a>
      <a href="./campaigns.html">QMA‑C360</a>
      <a class="active" aria-current="page" href="./protocols.html">Protocols</a>
    </nav>
  </header>

  <main>
    <!-- Estado de protocolos -->
    <section style="grid-column:1/-1">
      <h2>Estado & Progreso</h2>
      <p class="lead">Fuente: <span class="pill">protocols_status.json</span>. Seguimiento de Fast Response, COMIX, IFRL, Cerebrum y COMCON.</p>
      <div id="prot" class="grid-3">
        <div class="card skeleton"></div><div class="card skeleton"></div><div class="card skeleton"></div>
      </div>
      <div class="small" id="meta"></div>
    </section>

    <!-- COMCON: Brief táctico → Panels -->
    <section>
      <h2>COMCON · Brief táctico</h2>
      <p class="lead">Estandariza el relato del brief al lenguaje del universo ZDU. Fuente: <span class="pill">comcon_brief_sample.json</span></p>
      <div id="brief" class="card small">Cargando brief…</div>
    </section>

    <section>
      <h2>COMCON · Panels</h2>
      <div style="overflow-x:auto">
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>Layout</th>
              <th>Caption</th>
              <th>Diálogo</th>
              <th>SFX</th>
              <th>Assets</th>
            </tr>
          </thead>
          <tbody id="panels">
            <tr><td colspan="6">Cargando…</td></tr>
          </tbody>
        </table>
      </div>
      <div class="small" id="styleMeta"></div>
    </section>

    <!-- (Opcional) README Universo -->
<section>
  <h2>Universo ZDU · README</h2>
  <p class="lead">Resumen de <code>/private/universe/README_UNIVERSE.md</code> formateado como Markdown.</p>
  <div id="uniView" class="md card">Cargando README…</div>
</section>
  </main>

  <footer>
    ZDU QUALITY SYSTEM · Protocols · v2
  </footer>

<script>
// ==== Rutas ====
const LOGS = '/private/infra/scripts/logs/';
const PATH_PROT = LOGS + 'protocols_status.json';
const PATH_COMC = LOGS + 'comcon_brief_sample.json';
const PATH_UNI  = '/private/universe/README_UNIVERSE.md';

// ==== Helpers ====
const $ = (s)=>document.querySelector(s);
async function j(url){
  const r = await fetch(url, {cache:'no-store'});
  if(!r.ok) throw new Error(`${r.status} ${url}`);
  const ct = r.headers.get('content-type')||'';
  if(ct.includes('application/json')) return r.json();
  return r.text();
}
function esc(s){return String(s).replace(/[&<>"]/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[m]));}
function chip(status){
  const s = String(status||'').toLowerCase();
  const cls = (s==='done'||s==='ok'||s==='ready')?'ok':(s==='in_progress'||s==='wip'?'warn':'fail');
  return `<span class="pill ${cls}">${status}</span>`;
}

// ==== Render: Protocols & COMCON ====
function renderProtocols(ps){
  if(!Array.isArray(ps)||!ps.length){ $('#prot').innerHTML='<div class="card small">Sin datos</div>'; return; }
  $('#prot').innerHTML = ps.map(p=>`
    <div class="card">
      <div><b>${p.name}</b> ${chip(p.status)}</div>
      <div class="small">progress: ${p.progress??0}%</div>
      <div class="small">owner: ${p.owner||'-'}</div>
      <div class="small">milestones: ${(p.milestones||[]).slice(0,3).join(' · ')||'-'}</div>
    </div>
  `).join('');
  $('#meta').textContent = `Protocolos en seguimiento: ${ps.length}`;
}

function renderComcon(cc){
  const b = cc?.brief_tactico || '(sin brief)';
  const beats = (cc?.beats||[]).map((t,i)=>`${i+1}. ${t}`).join('\n');
  $('#brief').innerHTML = `
    <div><b>Brief:</b><br>${esc(b)}</div>
    <div style="margin-top:8px" class="small"><b>Beats:</b><br><pre style="margin:0">${esc(beats||'(sin beats)')}</pre></div>
    <div class="small" style="margin-top:8px"><b>Roles:</b> ${((cc?.roles||[]).map(r=>esc(r.name))).join(', ')||'-'}</div>
  `;
  const rows = (cc?.panels||[]).map(p=>`
    <tr>
      <td>${p.index}</td>
      <td>${esc(p.layout||'-')}</td>
      <td>${esc(p.caption||'-')}</td>
      <td>${(p.dialog||[]).map(esc).join(' | ')||'-'}</td>
      <td>${(p.sfx||[]).map(esc).join(', ')||'-'}</td>
      <td>${(p.assets||[]).map(esc).join(', ')||'-'}</td>
    </tr>
  `).join('');
  $('#panels').innerHTML = rows || '<tr><td colspan="6">Sin panels</td></tr>';
  const st = cc?.style || {};
  $('#styleMeta').innerHTML = `Estilo: ${esc(st.palette||'-')} · ${esc(st.line_art||'-')} · ${esc(st.lettering||'-')}`;
}

// ==== Mini Markdown Renderer (subset suficiente/offline) ====
function md2html(md){
  md = String(md||'').replace(/\r\n?/g, '\n');
  // ```code```
  md = md.replace(/```([\s\S]*?)```/g, (m,code)=>`<pre><code>${esc(code)}</code></pre>`);
  // # headers
  md = md.replace(/^(######)\s+(.*)$/gm, '<h6>$2</h6>')
         .replace(/^(#####)\s+(.*)$/gm, '<h5>$2</h5>')
         .replace(/^(####)\s+(.*)$/gm, '<h4>$2</h4>')
         .replace(/^(###)\s+(.*)$/gm, '<h3>$2</h3>')
         .replace(/^(##)\s+(.*)$/gm, '<h2>$2</h2>')
         .replace(/^#\s+(.*)$/gm, '<h1>$1</h1>');
  // > quote
  md = md.replace(/^\>\s?(.*)$/gm, '<blockquote>$1</blockquote>');
  // --- rule
  md = md.replace(/^\s*---+\s*$/gm, '<hr>');
  // list simple
  md = md.replace(/(?:^(?:-|\*)\s+.*\n?)+/gm, block=>{
    const items = block.trim().split('\n').map(line=>line.replace(/^(?:-|\*)\s+(.*)$/,'<li>$1</li>')).join('');
    return `<ul>${items}</ul>`;
  });
  // `inline code`
  md = md.replace(/`([^`]+)`/g, (m,code)=>`<code>${esc(code)}</code>`);
  // **bold** / *italic*
  md = md.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
         .replace(/\*([^*]+)\*/g, '<em>$1</em>');
  // [text](url)  <-- CORRECTO
  md = md.replace(/$begin:math:display$([^$end:math:display$]+)\]$begin:math:text$([^)]+)$end:math:text$/g, '<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>');
  // párrafos
  md = md.split('\n').map(line=>{
    if(!line.trim()) return '';
    if(/^<\/?(h\d|ul|li|pre|code|blockquote|hr|p)/.test(line)) return line;
    return `<p>${line}</p>`;
  }).join('\n');
  return md;
}

// ==== Fallback del README: si no carga, usa protocols_status.json ====
function renderReadmeFallback(ps){
  if(!Array.isArray(ps) || !ps.length){
    $('#uniView').innerHTML = `<div class="pill fail">README no disponible y sin datos de protocolos para fallback.</div>`;
    return;
  }
  const blocks = ps.map(p=>{
    const miles = (p.milestones||[]).slice(0,3).map(m=>`- ${esc(m)}`).join('\n') || '- (sin hitos)';
    return `### ${esc(p.name)} ${esc(p.status)} (${p.progress||0}%)
**Owner:** ${esc(p.owner||'-')}

**Hitos próximos**
${miles}
`;
  }).join('\n\n---\n\n');
  const md = `# Universo ZDU (resumen operativo)\n\n> Fallback automático: README_UNIVERSE.md no disponible por HTTP.\n\n${blocks}`;
  $('#uniView').innerHTML = md2html(md);
}

// ==== Boot ====
(async ()=>{
  // 1) Protocolos + COMCON
  try{
    const [ps, cc] = await Promise.all([ j(PATH_PROT), j(PATH_COMC) ]);
    renderProtocols(ps);
    renderComcon(cc);
    // 2) README (si falla, fallback con ps)
    try{
      const t = await j(PATH_UNI);
      $('#uniView').innerHTML = md2html(t);
    }catch(_){
      renderReadmeFallback(ps);
    }
  }catch(e){
    $('#prot').innerHTML = `<div class="card fail small">Error al cargar protocolos/COMCON: ${esc(e.message||e)}</div>`;
    // si no hay protocolos, intenta de todas formas leer README plano
    try{
      const t = await j(PATH_UNI);
      $('#uniView').innerHTML = md2html(t);
    }catch(_){
      $('#uniView').innerHTML = `<div class="pill fail">No disponible por HTTP</div><div class="small">${esc(String(_.message||_))}</div>`;
    }
  }
})();
</script>

</body>
</html>